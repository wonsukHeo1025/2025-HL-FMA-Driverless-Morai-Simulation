# **Phase 4: 3단계 검증 및 튜닝 워크플로우 (v2)**

## **1. 개요**

본 문서는 개발된 MPC 제어 시스템의 성능을 체계적으로 검증하고 튜닝하기 위한 **3단계 워크플로우**를 정의합니다. 이 워크플로우는 문제의 원인을 명확히 분리하고, 점진적으로 시스템의 복잡도를 높여가며 강인성을 확보하는 것을 목표로 합니다.

-   **1단계: 제어기 코어 및 시스템 모델 검증 (TF 기반)**
-   **2단계: 상태 추정기 개발 및 평가 (IMU/GPS 기반)**
-   **3단계: 통합 시스템 강인성 검증 및 튜닝**

## **2. 1단계: 제어기 코어 및 시스템 모델 검증**

-   **목표**: 상태 추정 오차라는 변수를 완전히 배제하고, `MpcCore`의 로직과 `Phase 1`에서 추정한 시스템 모델(`A,B,d`)의 정확성을 순수하게 검증합니다.
-   **절차**:
    1.  `mpc_controller_node.py`를 `_state_source:=tf` 파라미터와 함께 실행합니다.
    2.  다양한 검증 시나리오(정속 주행, 가감속 등)를 실행합니다.
    3.  PlotJuggler를 사용하여 `/tf`에서 계산된 속도와 `/target_velocity`를 비교 분석합니다.
-   **성능 지표 (KPIs)**:
    -   **RMSE (Root Mean Square Error)**: 목표 속도와 TF 기반 실제 속도 간의 오차.
    -   **Overshoot**: 목표 속도 변경 시 초과 달성 정도.
    -   **Settling Time**: 목표 속도에 안정적으로 수렴하는 시간.
-   **판단 기준**: 이 단계에서 KPI가 만족스럽지 않다면, 원인은 **100% `MpcCore`의 로직 또는 시스템 모델(`A,B,d`)의 부정확성**에 있습니다. 상태 추정기는 고려 대상이 아닙니다. `A,B,d` 값을 재추정하거나, MPC 가중치(`Q,R`)를 1차적으로 튜닝합니다.

## **3. 2단계: 상태 추정기 개발 및 평가**

-   **목표**: 실제 차량과 동일한 환경에서, IMU/GPS 센서 데이터로부터 차량의 상태(위치, 속도)를 추정하는 모듈을 개발하고, 그 성능을 정량적으로 평가합니다.
-   **절차**:
    1.  `robot_localization` 패키지를 설정하여 IMU, GPS 토픽을 입력받는 상태 추정 노드를 구성하고 실행합니다.
    2.  차량을 수동 또는 자동으로 주행시키며 `/odometry/filtered` 토픽이 발행되는 것을 확인합니다.
    3.  **성능 평가**: PlotJuggler에서 상태 추정기의 출력인 `/odometry/filtered`의 `pose.pose.position` 및 `twist.twist.linear`를 **"정답"인 `/tf` 데이터**와 함께 플로팅하여 비교합니다.
-   **성능 지표 (KPIs)**:
    -   **위치 및 속도 추정 RMSE**: TF 값 대비 상태 추정치의 평균 오차.
    -   **드리프트(Drift) 분석**: 장시간 주행 시 오차가 누적되어 발산하는지 확인.
-   **판단 기준**: 추정 오차가 너무 크거나 발산하는 경우, `robot_localization`의 설정(프로세스/측정 노이즈 공분산 등)을 튜닝해야 합니다.

## **4. 3단계: 통합 시스템 강인성 검증 및 튜닝**

-   **목표**: 현실적인 추정 오차를 포함한 전체 시스템에서 제어기가 얼마나 안정적이고 강인하게(robust) 동작하는지 최종 검증하고 튜닝합니다.
-   **절차**:
    1.  `mpc_controller_node.py`를 `_state_source:=estimator` 파라미터와 함께 실행합니다.
    2.  2단계에서 개발한 상태 추정기 노드(`robot_localization`)를 **동시에** 실행합니다.
    3.  1단계와 동일한 검증 시나리오를 다시 수행합니다.
-   **성능 지표 (KPIs)**:
    -   1단계와 동일한 KPI(RMSE, Overshoot 등)를 다시 측정합니다.
    -   **제어 입력의 안정성**: 제어 입력(`u*`)이 추정 오차로 인해 과도하게 떨거나 진동하지 않는지 확인.
-   **판단 기준**:
    -   1단계에 비해 성능이 소폭 하락하는 것은 정상입니다.
    -   만약 제어기가 불안정해지거나 진동이 발생한다면, 이는 제어기가 상태 추정 오차에 민감하다는 의미입니다.
    -   이때는 MPC 가중치, 특히 **제어 입력의 크기나 변화량에 대한 페널티인 `R` 값을 높여** 제어기를 더 부드럽고 둔감하게 만들어 강인성을 확보해야 합니다.

## **5. 최종 결론**

이 3단계 워크플로우를 모두 통과한 제어 시스템은 로직의 정확성, 상태 추정의 신뢰성, 통합 시스템의 강인성을 모두 검증받은 것으로 볼 수 있습니다. 이후 센서에 실제 노이즈를 추가하거나 실제 차량에 탑재할 때 발생할 수 있는 문제를 최소화할 수 있습니다.