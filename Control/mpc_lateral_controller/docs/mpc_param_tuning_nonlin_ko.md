### 목적
- **제로크로싱 오실레이션 완화**: 경로 중심선에 대한 좌우 오차가 0을 중심으로 왕복(양/음)하는 현상 감소.
- **직관적 조향 거동**: 직선에서는 ‘두께가 있는 경로’ 내부에선 살살(저감도) 제어, 커브에서 벗어나면 강하게 복귀.
- **비선형적 가중(로버스트 커널/데드존/밴드 추적)**을 통해, 작은 오차엔 약하게, 큰 오차엔 강하게 반응하도록 비용함수/제약을 설계.

---

### 직관 → 수식화: ‘두께가 있는 경로’와 잉크 농도 비유
- **밴드(band) 추적**: 중심선 주변 ±w 미터를 허용 밴드로 정의. 밴드 내부에서는 오차 비용을 0 또는 매우 작게, 밴드 바깥으로 벗어나면 비용을 급격히 증가.
- **잉크 농도(중앙 짙고 가장자리 옅음)**: 중심선 근처에서 비용 증가율을 낮추고, 밴드 바깥에서 증가율을 크게 하여 비선형 감도를 구현.
- **로버스트 커널**: Huber/Tukey와 유사한 비용 형태로 작은 오차는 2차(부드럽고 완만), 큰 오차는 1차 또는 포화형/가파른 2차로 전환.

---

### MPC에서 구현 가능한 4가지 접근
1) 밴드 기반 소프트 제약(추천: QP로 자연스럽게 구현 가능)
- 아이디어: lateral error e(k)에 대해 허용 밴드 w를 두고, 이를 넘는 양만 `soft` slack으로 벌점.
- 형식:
  - 선형 제약: `e(k) - w ≤ s_pos(k)`, `-e(k) - w ≤ s_neg(k)`, `s_pos(k) ≥ 0`, `s_neg(k) ≥ 0`
  - 목적함수에 `λ_out * (s_pos(k) + s_neg(k))^2` 또는 `λ_out * (s_pos + s_neg)`를 추가
  - 밴드 내부(|e|≤w)는 slack=0 → 비용 거의 없음. 바깥(|e|>w)에서는 slack>0에 큰 벌점.
- 장점: QP(2차 + 선형제약) 안에서 그대로 표현 가능. 안정적이고 해석이 쉬움.
- 튜닝 파라미터: `w`(밴드 두께), `λ_out`(밴드 외부 벌점 강도).

2) IRLS(Iteratively Reweighted Least Squares)로 로버스트 커널 근사
- 아이디어: 비용을 `Σ w_i * e_i^2`로 유지하되, 반복마다 가중치 `w_i`를 오차 크기에 따라 갱신하여 Huber/Tukey 유사 거동.
- 절차(각 제어 스텝 내부에서 1~3회 반복 권장):
  1. 초기 `w_i = 1`
  2. QP 풀기 → `e_i`
  3. `w_i ← robust_weight(|e_i|; kappa)`로 갱신(Huber 등)
  4. 수렴 또는 반복 횟수 도달 시 종료
- 장점: QP 틀 유지. 작은 오차 둔감, 큰 오차 민감 효과 달성.
- 단점: 추가 반복 → 계산비용 증가. 실시간성 고려 필요(50 Hz 내 예산 확인).

3) 시간/상태 의존 가중(Time-/State-varying Weights)
- 아이디어: 예측지평 k에 따라 `Q(k)`를 달리하거나, `|e(k)|`가 작으면 낮게, 크면 높게(구간화) 설정.
- 예: 밴드 내부(|e|≤w_in) `Q_small`, 중간(w_in<|e|≤w_out) `Q_mid`, 외부(|e|>w_out) `Q_large`로 piecewise-constant.
- 구현: 완전한 비선형 대신, 구간별로 시뮬레이션-오프라인에서 프로파일을 만들고 온라인은 고정 표 참조(스케줄링). QP는 한 번만 풂.

4) 출력단 보조 PID(빠른 임시 완화책)
- 아이디어: MPC의 조향 출력 δ에 **작은 데드존/저주파 필터/소량 D**를 가진 외부 PID(또는 PD) 블록을 직렬로 추가.
- 장점: 구현 간단, 즉시 제로크로싱 진폭 감소 가능.
- 단점: MPC 최적화 목적과 충돌 위험, 상호작용 복잡. 장기적으로는 1)~3)로 내재화 권장.

---

### 구체적 비용 설계 예시
1) 밴드 소프트 제약(선형 제약 + 2차 벌점)
- 파라미터: 밴드 폭 `w(v, κ)`를 속도 v, 곡률 κ에 따라 스케줄링
  - 예: `w = w0 + a * v + b / max(κ, κ_min)` (직선/고속에서 약간 넓게, 급커브에서 좁게)
- 목적함수 항:
  - `J_band = Σ λ_out * (s_pos(k) + s_neg(k))^2`
  - λ_out은 `Q_lateral` 대비 5~50배로 시작해 실험적으로 조정

2) Huber 커널의 IRLS 근사
- Huber ρ(e; κ):
  - |e| ≤ κ: 0.5 e^2
  - |e| > κ: κ(|e| − 0.5κ)
- IRLS 가중치 업데이트(한 예):
  - `w(e) = 1` if |e|≤κ, else `w(e) = κ/|e|`
- MPC 내부 루프 의사코드:
```pseudo
w_i ← 1  (모든 i)
repeat r times (r=1~3):
  Solve QP: minimize Σ w_i * e_i^2 + R*||Δu||^2 + ...
  Measure e_i from solution
  For all i: w_i ← robust_weight(|e_i|; κ)
until r reached
```
- κ는 속도/곡률에 따라 스케줄링 가능.

3) 시간 가변 말기 가중(terminal cost P) 강화
- `P`를 크게 하고, `Q(k)`를 말기(`k ≈ Np`)로 갈수록 증가 → 목표선으로 수렴은 강제하되, 초기엔 과도 제어 완화.
- 직관: 가까운 미래에서는 살살, 멀리서는 반드시 복귀.

---

### 제어 입력 측면 완화: R, R_delta, rate/amp 제한
- **R(입력 비용)**: 크면 조향 사용을 아낌. 오실레이션 진폭 감소. 너무 크면 추종 느림.
- **R_delta(변화율 비용)**: 크면 고주파/널뛰기 억제. 너무 크면 코너 진입 응답 둔화.
- **delta_rate_max(물리 rate 제한)**: 작게 하면 스파이크 억제. 너무 작으면 선회 추종 실패.
- **delta_limits(조향 한계)**: 현실 반영. 밴드 외부에서 포화되면 복귀 지연 유의.

---

### Np, Nc, Q, R, P 조합 시나리오와 효과
- **기본 상호작용**
  - **Np↑**: 더 먼 미래 고려 → 전반적으로 매끄럽고 예견적. 계산량↑, 모델 불확실성 영향↑.
  - **Nc↑**: 제어 자유도↑ → 응답 민첩하지만 오버액팅 위험. R_delta로 제어.
  - **Q↑(lateral/yaw)**: 경로오차 억제↑ → 진동 가능성↑. R, R_delta와 균형.
  - **P↑(terminal)**: 말기 수렴 강제 → 중간 구간의 잔진동 감소에 도움. 과대하면 마지막에 급제어.
  - **R↑**: 입력 절약 → 진동/노이즈 억제. 추종 지연↑.
  - **R_delta↑**: 고주파 억제 → 응답 속도↓, 코너 대응력↓.

- **대표 시나리오**
  1. 직선구간 제로크로싱 감소(매끄러움 최우선)
     - R↑, R_delta↑, Nc↓(약간), Np↑(약간), Q(밴드 내)↓, Q(밴드 외)↑, delta_rate_max↓(소폭)
     - 효과: 작은 오차에 소극적, 큰 오차에는 확실히 복귀. 고주파 억제.
  2. 급커브 진입 응답 강화(추종 우선)
     - Q_yaw↑, P↑, Nc↑, delta_rate_max↑, R↓(소폭), R_delta↓(소폭)
     - 효과: 코너에서 중심선 재획득 능력↑. 다만 직선에서 잔진동↑ 가능 → 밴드/IRLS로 상쇄.
  3. 고속 직선 안정성(노이즈/풍 영향 억제)
     - v에 따라 w↑(밴드 확대), R↑, R_delta↑, Q(밴드 내)↓↓, Q(밴드 외)↑
     - 효과: 미소 오차 무시, 불필요한 조향 미세동작 제거.
  4. 저속 정밀 주행(차선 중앙 정렬)
     - w↓(밴드 축소), Q↑, P↑, R↓, R_delta(중간)
     - 효과: 중심선 정밀 추종, 오실레이션은 저속이라 영향 적음.
  5. 계산예산 제한 환경
     - Np↓, Nc↓, Q/P 보수적, R_delta↑로 매끄러움 확보
     - 효과: 실시간성 확보. 추종 성능 일부 양보.

- **상쇄 관계 요약**
  - Q↑ ↔ R↑/R_delta↑: 추종성 vs 매끄러움(진동 억제)
  - Nc↑ ↔ R_delta↑/delta_rate_max↓: 민첩성 vs 변동 억제
  - Np↑ ↔ 모델 오차/계산비용: 예견성 vs 안정성/실시간성
  - 밴드 폭 w↑ ↔ 중심 정렬 정밀도: 오실레이션 억제 vs 센터 정렬 집착도 감소

---

### 권장 튜닝 절차(실무 가이드)
1) 안전/물리 한계 먼저 고정
   - `delta_limits`, `delta_rate_max`를 차량/시스템 한계에 맞춤.
2) 밴드 기반 소프트 제약 도입
   - 초기값: `w = 0.15~0.25 m`, `λ_out = 10×Q_lateral` 수준에서 시작.
   - 속도/곡률 스케줄: 고속직선 w↑(0.25~0.35), 급커브 w↓(0.10~0.20).
3) 매끄러움 셋업
   - `R_delta`를 현 수준보다 1.2~2.0× 시도. 고주파 잔진동이 사라질 때까지.
   - `R`은 직선의 스티어 마이크로진동이 사라질 정도로만 점증.
4) 추종 보강
   - 커브 대응이 약하면 `Q_yaw`, `P`를 순차적으로 증가. 필요 시 `Nc` 소폭↑, `delta_rate_max`도 0.005~0.01 rad/step 범위로 재조정.
5) 미세조정
   - 직선잔진동이 남으면 `w↑` 또는 `IRLS 1~2회 반복` 추가.
   - 코너 오버슈트면 `R_delta↑`와 `말기 P↑`, `Q(k)` 말기 증가 프로파일 적용.

---

### 출력단 PID 블록 추가에 대한 의견
- **짧은 기간 핫픽스**로는 유효: 작은 데드존(예: |e|<0.05 m)에서 출력 0, 소량 D로 속도 종속 감쇠, 약한 P.
- 권장 세팅 예시(개념):
  - Deadzone: |e|<0.03~0.06 m → 0
  - PD: P_small(0.1~0.3), D_small(속도 비례 가중), I=0 또는 매우 작게
- 단, 장기적으로는 **MPC 비용/제약에 내재화(밴드/IRLS/시간가변 가중)**가 바람직. 상호간 간섭을 줄이고 최적화 일관성을 유지.

---

### 현재 코드베이스 관점 구현 포인트
- 파일 참조:
  - `Control/mpc_lateral_controller/config/mpc_params.yaml`: Q/P/R/R_delta, horizon, rate limits 등 가중 파라미터.
  - `Control/mpc_lateral_controller/src/mpc_lateral_controller/lateral_mpc_core.py`: 비용/제약 구성부(소프트 제약, slack 추가 후보).
- 구현 순서 제안:
  1) 소프트 제약용 slack 변수 추가 및 목적함수 항 `λ_out * ||s||^2` 도입.
  2) 밴드 폭 `w(v, κ)` 스케줄러 추가(속도, 곡률 구독/추정값 활용).
  3) 필요 시 IRLS 1~2회 반복(실시간 예산 확인). 반복 회수/κ는 파라미터화.
  4) `Q(k)` 시간가변 프로파일(말기 증가) 적용.

---

### 제안 기본값(출발점)
- 밴드 폭: `w0 = 0.2 m`, 고속직선 `w = 0.3 m`, 급커브 `w = 0.15 m`
- 외부 벌점: `λ_out = 10×Q_lateral`
- 매끄러움: `R_delta = 기존×1.5`, `R = 기존×1.2`
- 말기 가중: `P = 기존×1.3`, `Q(k)`는 선형 상승(앞 50% 구간은 Q×0.7, 뒤 50%는 Q×1.3)
- Np/Nc: 실시간성 유지 범위에서 `Np +10~20%`, `Nc +0~+2`

---

### 체크리스트(실험 계획)
- [ ] 직선 시 제로크로싱 RMS/peak 비교 전후(밴드/IRLS 적용)
- [ ] 급커브 최대 추종 오차, 복귀 시간, 포화 시간
- [ ] 스티어 레이트 한계 근접 빈도, 솔버 시간(99퍼센타일)
- [ ] 속도별 밴드 스케줄 효과(고속 vs 저속)
- [ ] IRLS 반복수 변화에 따른 지연/성능 트레이드오프

---

### 요약
- **밴드 소프트 제약**으로 ‘두께 있는 경로’ 직관을 QP 안에서 직접 구현 가능.
- **IRLS 로버스트 가중**과 **시간가변 말기 가중**으로 작은 오차 둔감, 큰 오차 민감 효과를 추가.
- **R/R_delta, Np/Nc, Q/P**의 조합 시나리오를 통해 직선 매끄러움과 커브 추종성을 균형 있게 달성.
- 출력단 PID는 단기 보조로는 유효하나, 장기적으로는 비용/제약 내재화가 더 일관되고 안정적.